# Lolicon 插件

调用 Lolicon API v2 发送随机二次元图片的 QQ 机器人插件。

## 功能特性

- 🖼️ 调用 Lolicon API v2 获取高质量二次元图片
- 💾 本地缓存功能，减少重复下载
- 🔒 R18 内容权限控制，仅限私聊或管理员使用
- 🏷️ 支持单个标签搜索（优化性能）
- 📊 缓存状态管理和API状态检查
- ⚡ 并发下载和批量发送，提升响应速度
- 🔍 实时API接口可用性检测
- 智能防重复机制，避免获取相同图片

## 安装依赖

```bash
pip install -r requirements.txt
```

## 配置说明

插件支持以下配置项：

- `cache_expire`: 缓存过期时间(秒)，默认 3600 (1小时)
- `batch`: 一批发送的图片数量，默认 5
- `lim_f`: 不使用转发的阈值，默认 3
- `lim_u`: 用户一次请求最大发送数量，默认 10
- `enable_r18`: 是否启用 R18 内容，默认 False
- `r18_private_only`: R18 内容是否仅限私聊，默认 True
- `api_timeout`: API请求超时时间(秒)，默认 15
- `download_timeout`: 图片下载超时时间(秒)，默认 10
- `send_retry_count`: 发送消息重试次数，默认 2
- `batch_delay`: 批次间延迟时间(秒)，默认 0.2

### 启用 R18 功能

要启用 R18 功能，可以通过以下方式：

#### 通过QQ消息配置

管理员可以直接在QQ中发送以下命令：

```
/enable_r18                    # 启用R18功能
/disable_r18                   # 禁用R18功能
```

**注意**：启用 R18 功能后，请确保遵守相关法律法规，仅在合适的场合使用。

## 使用命令

### 用户命令

- `/loli [数量] [标签]` - 发送随机二次元图片
  - 示例：`/loli`、`/loli 3`、`/loli 5 萝莉`、`/loli 萝莉`
  - **注意**：只支持单个标签，多个标签时只使用第一个

- `/r18 [数量] [标签]` - 发送 R18 二次元图片(需要权限)
  - 示例：`/r18`、`/r18 3`、`/r18 5 萝莉`、`/r18 萝莉`
  - 需要启用 R18 功能且有相应权限
  - **注意**：只支持单个标签，多个标签时只使用第一个

**参数说明**：
- 如果第一个参数是数字，则作为数量，后面的参数作为标签
- 如果第一个参数不是数字，则所有参数都作为标签，数量默认为1
- **标签限制**：只使用第一个标签，忽略后续标签
- 示例：`/loli 萝莉 白丝` = 1张包含"萝莉"标签的图片（忽略"白丝"）

### 管理员命令

- `/status` - 查看插件状态（包含API接口状态检查）
- `/clear_cache` - 清理图片缓存
- `/enable_r18` - 启用R18功能
- `/disable_r18` - 禁用R18功能

### 使用限制

- 所有用户一次最多可请求 10 张图片
- 超过 3 张图片会使用合并转发消息发送

## 性能优化

### 1. 并发下载
- 支持最多5个并发下载任务
- 大幅提升多图片获取速度

### 2. 缓存机制
- 图片自动缓存到 `plugins/Lolicon/cache/` 目录
- 缓存索引保存在 `cache_index.json` 文件中
- 支持缓存过期时间配置（默认1小时）
- 提供缓存清理和状态查看功能
- 自动清理过期缓存文件

### 3. 防重复机制
- 添加随机UID参数避免API返回重复图片
- 基于时间戳的缓存文件命名，每小时更新
- 缩短缓存过期时间，增加图片多样性
- 自动清理过期缓存，保持新鲜度

### 4. 超时优化
- API请求超时：15秒
- 图片下载超时：10秒
- 重试次数优化：减少不必要的重试

### 5. API状态检查
- 实时检测API接口可用性
- 显示响应时间和连接状态
- 帮助诊断网络问题

## API 说明

本插件调用 [Lolicon API v2](https://docs.api.lolicon.app/#/setu) 接口：

- 接口地址：`https://api.lolicon.app/setu/v2`
- 返回格式：JSON
- 支持状态检查：`/status` 命令可查看API状态

## 使用示例

### 基础用法
```
/loli                    # 获取1张随机图片
/loli 3                 # 获取3张随机图片
/loli 萝莉              # 获取1张萝莉图片
/loli 5 可爱            # 获取5张可爱图片
```

### R18用法（需要权限）
```
/r18                    # 获取1张R18图片
/r18 3                 # 获取3张R18图片
/r18 御姐              # 获取1张御姐R18图片
/r18 5 黑丝            # 获取5张黑丝R18图片
```

### 管理员功能
```
/status                 # 查看插件状态和API状态
/clear_cache            # 清理图片缓存
/enable_r18             # 启用R18功能
/disable_r18            # 禁用R18功能
```

## 注意事项

1. **标签限制**：只支持单个标签，多个标签时只使用第一个
2. **性能优化**：并发下载和缓存机制大幅提升响应速度
3. **API状态**：可通过 `/status` 命令检查API接口状态
4. **合理使用**：请合理使用 API，避免频繁请求
5. **R18内容**：R18 内容请遵守相关法律法规
6. **缓存管理**：建议定期清理缓存以节省存储空间
7. **版权尊重**：图片版权归原作者所有，请尊重版权
8. **防重复机制**：插件已内置防重复机制，减少获取相同图片的概率 